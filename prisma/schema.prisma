// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BusinessProfile {
  id            Int     @id @default(autoincrement())
  business_name String  @db.VarChar(255)
  gstin         String  @unique @db.VarChar(15)
  address       String  @db.Text
  city          String  @db.VarChar(100)
  vat_tin       String? @db.VarChar(20)

  state_id Int? // FK to States.id
  state    States? @relation(fields: [state_id], references: [id])

  pan_number     String?  @db.VarChar(10)
  bank_name      String?  @db.VarChar(100)
  account_number String?  @db.VarChar(20)
  branch_ifsc    String?  @db.VarChar(20)
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now()) @updatedAt
}

model States {
  id                 Int               @id @default(autoincrement()) // use this as PK
  state_name         String            @db.VarChar(50)
  state_code         String            @db.VarChar(2)
  state_numeric_code Int               @unique // make numeric and unique
  business_profiles  BusinessProfile[]
  Customer           Customer[]
}

model Customer {
  id      Int    @id @default(autoincrement())
  name    String @db.VarChar(255)
  address String @db.Text
  city    String @db.VarChar(100)

  state_id Int? // FK to States.id
  state    States? @relation(fields: [state_id], references: [id])

  pan_number String?   @db.VarChar(10)
  pincode    String?   @db.VarChar(10)
  gstin      String?   @unique @db.VarChar(15)
  phone      String    @db.VarChar(15)
  email      String?   @db.VarChar(100)
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now()) @updatedAt
  invoices   Invoice[]
}

model Invoice {
  id                  Int        @id @default(autoincrement())
  invoice_number      String     @unique @db.VarChar(50)
  invoice_date        DateTime
  transaction_type    String     @db.VarChar(20) // 'retail', 'inter_state', 'outer_state', 'purchase'
  input_mode          String     @db.VarChar(20) // 'component', 'direct', 'reverse'
  eway_bill           String?    @db.VarChar(50)
  buyer_id            Int?
  buyer_name          String     @db.VarChar(255)
  buyer_address       String     @db.Text
  buyer_gstin         String?    @db.VarChar(15)
  buyer_state_code    Int?
  tax_type            String     @db.VarChar(20) // 'CGST+SGST', 'IGST'
  total_invoice_value Decimal    @db.Decimal(12, 2)
  flagged             Boolean    @default(false)
  created_at          DateTime   @default(now())
  updated_at          DateTime   @default(now()) @updatedAt
  customer            Customer?  @relation(fields: [buyer_id], references: [id])
  line_items          LineItem[]
}

model LineItem {
  id            Int           @id @default(autoincrement())
  invoice_id    Int
  hsn_sac_code  String        @db.VarChar(10)
  description   String        @db.VarChar(255)
  quantity      Decimal       @db.Decimal(10, 3)
  unit          String        @db.VarChar(10)
  rate          Decimal       @db.Decimal(12, 2)
  taxable_value Decimal       @db.Decimal(12, 2)
  created_at    DateTime      @default(now())
  invoice       Invoice       @relation(fields: [invoice_id], references: [id])
  taxes         LineItemTax[]
}

model LineItemTax {
  id           Int      @id @default(autoincrement())
  line_item_id Int
  tax_name     String   @db.VarChar(20) // 'CGST', 'SGST', 'IGST'
  tax_rate     Decimal  @db.Decimal(5, 2)
  tax_amount   Decimal  @db.Decimal(12, 2)
  created_at   DateTime @default(now())
  line_item    LineItem @relation(fields: [line_item_id], references: [id])
}

model InvoiceSetting {
  id                       Int             @id @default(autoincrement())
  invoice_prefix           String          @default("JVJ/D/") @db.VarChar(20)
  prefix_retail            String          @default("JVJ/D/") @db.VarChar(20)
  prefix_inter_city        String          @default("JVJ/D/") @db.VarChar(20)
  prefix_outer_state       String          @default("JVJ/S/") @db.VarChar(20)
  default_transaction_type TransactionType @default(retail)
  number_digits            Int             @default(3) // Number of digits in sequence (3 = 001-999)
  default_input_mode       InputMode       @default(component)
  starting_number          Int             @default(1)
  generate_original        Boolean         @default(true) // Original for Recipient
  generate_duplicate       Boolean         @default(true) // Duplicate for Transporter
  generate_triplicate      Boolean         @default(true) // Triplicate for Supplier
  created_at               DateTime        @default(now())
  updated_at               DateTime        @default(now()) @updatedAt
}

model TaxRate {
  id          Int      @id @default(autoincrement())
  hsn_code    String   @unique @db.VarChar(10)
  description String   @db.VarChar(255)
  cgst_rate   Decimal  @db.Decimal(5, 2)
  sgst_rate   Decimal  @db.Decimal(5, 2)
  igst_rate   Decimal  @db.Decimal(5, 2)
  is_default  Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt
}

enum TransactionType {
  retail
  inter_state
  purchase
}

enum InputMode {
  component
  direct
  reverse
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique @db.VarChar(100)
  password   String   @db.VarChar(255)
  name       String   @db.VarChar(100)
  role       UserRole @default(admin)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
}

enum UserRole {
  admin
  user
}
